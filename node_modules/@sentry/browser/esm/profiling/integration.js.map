{"version":3,"file":"integration.js","sources":["../../../../src/profiling/integration.ts"],"sourcesContent":["import { convertIntegrationFnToClass, defineIntegration, getCurrentScope } from '@sentry/core';\nimport type { Client, EventEnvelope, Integration, IntegrationClass, IntegrationFn, Transaction } from '@sentry/types';\nimport type { Profile } from '@sentry/types/src/profiling';\nimport { logger } from '@sentry/utils';\n\nimport { DEBUG_BUILD } from '../debug-build';\nimport { startProfileForTransaction } from './hubextensions';\nimport type { ProfiledEvent } from './utils';\nimport {\n  addProfilesToEnvelope,\n  createProfilingEvent,\n  findProfiledTransactionsFromEnvelope,\n  getActiveProfilesCount,\n  isAutomatedPageLoadTransaction,\n  shouldProfileTransaction,\n  takeProfileFromGlobalCache,\n} from './utils';\n\nconst INTEGRATION_NAME = 'BrowserProfiling';\n\nconst _browserProfilingIntegration = (() => {\n  return {\n    name: INTEGRATION_NAME,\n    // TODO v8: Remove this\n    setupOnce() {}, // eslint-disable-line @typescript-eslint/no-empty-function\n    setup(client) {\n      const scope = getCurrentScope();\n\n      // eslint-disable-next-line deprecation/deprecation\n      const transaction = scope.getTransaction();\n\n      if (transaction && isAutomatedPageLoadTransaction(transaction)) {\n        if (shouldProfileTransaction(transaction)) {\n          startProfileForTransaction(transaction);\n        }\n      }\n\n      if (typeof client.on !== 'function') {\n        logger.warn('[Profiling] Client does not support hooks, profiling will be disabled');\n        return;\n      }\n\n      client.on('startTransaction', (transaction: Transaction) => {\n        if (shouldProfileTransaction(transaction)) {\n          startProfileForTransaction(transaction);\n        }\n      });\n\n      client.on('beforeEnvelope', (envelope): void => {\n        // if not profiles are in queue, there is nothing to add to the envelope.\n        if (!getActiveProfilesCount()) {\n          return;\n        }\n\n        const profiledTransactionEvents = findProfiledTransactionsFromEnvelope(envelope);\n        if (!profiledTransactionEvents.length) {\n          return;\n        }\n\n        const profilesToAddToEnvelope: Profile[] = [];\n\n        for (const profiledTransaction of profiledTransactionEvents) {\n          const context = profiledTransaction && profiledTransaction.contexts;\n          const profile_id = context && context['profile'] && context['profile']['profile_id'];\n          const start_timestamp = context && context['profile'] && context['profile']['start_timestamp'];\n\n          if (typeof profile_id !== 'string') {\n            DEBUG_BUILD && logger.log('[Profiling] cannot find profile for a transaction without a profile context');\n            continue;\n          }\n\n          if (!profile_id) {\n            DEBUG_BUILD && logger.log('[Profiling] cannot find profile for a transaction without a profile context');\n            continue;\n          }\n\n          // Remove the profile from the transaction context before sending, relay will take care of the rest.\n          if (context && context['profile']) {\n            delete context.profile;\n          }\n\n          const profile = takeProfileFromGlobalCache(profile_id);\n          if (!profile) {\n            DEBUG_BUILD && logger.log(`[Profiling] Could not retrieve profile for transaction: ${profile_id}`);\n            continue;\n          }\n\n          const profileEvent = createProfilingEvent(\n            profile_id,\n            start_timestamp as number | undefined,\n            profile,\n            profiledTransaction as ProfiledEvent,\n          );\n          if (profileEvent) {\n            profilesToAddToEnvelope.push(profileEvent);\n          }\n        }\n\n        addProfilesToEnvelope(envelope as EventEnvelope, profilesToAddToEnvelope);\n      });\n    },\n  };\n}) satisfies IntegrationFn;\n\nexport const browserProfilingIntegration = defineIntegration(_browserProfilingIntegration);\n\n/**\n * Browser profiling integration. Stores any event that has contexts[\"profile\"][\"profile_id\"]\n * This exists because we do not want to await async profiler.stop calls as transaction.finish is called\n * in a synchronous context. Instead, we handle sending the profile async from the promise callback and\n * rely on being able to pull the event from the cache when we need to construct the envelope. This makes the\n * integration less reliable as we might be dropping profiles when the cache is full.\n *\n * @experimental\n * @deprecated Use `browserProfilingIntegration()` instead.\n */\n// eslint-disable-next-line deprecation/deprecation\nexport const BrowserProfilingIntegration = convertIntegrationFnToClass(\n  INTEGRATION_NAME,\n  browserProfilingIntegration,\n) as IntegrationClass<Integration & { setup: (client: Client) => void }>;\n\n// eslint-disable-next-line deprecation/deprecation\nexport type BrowserProfilingIntegration = typeof BrowserProfilingIntegration;\n"],"names":[],"mappings":"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"}